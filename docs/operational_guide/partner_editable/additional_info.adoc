== Deployment state machine
[#architecture2]
.Partner Solution deployment state machine architecture for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/quickstart-cisco-ise-on-aws-architecture-DeploymentStateMachine.png[DeploymentStateMachineArchitecture]

As shown in <<architecture2>>, this Partner Solution includes a deployment state machine to form a two-node {partner-product-short-name} deployment. The deployment state machine performs the following functions:

. Check {partner-product-short-name} status to verify that both {partner-product-short-name} instances are up and ready.
. Set the first {partner-product-short-name} instance as the primary administrator node (primary PAN or PPAN) of a new {partner-product-short-name} deployment.
. Register the second {partner-product-short-name} instance as the secondary administrator node (secondary PAN or SPAN) in the same {partner-product-short-name} deployment.
. Check the deployment sync status to verify that both nodes are synchronized.

NOTE: CloudFormation deploys the state machine architecture towards the end of the stack creation.

== PAN Failover State Machine
[#architecture3]
.Partner Solution Failover State Machine architecture for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/quickstart-cisco-ise-on-aws-architecture-FailoverStateMachine.png[FailoverStateMachineArchitecture]

As shown in <<architecture3>>, this Partner Solution deploys a failover state machine to promote SPAN to PPAN in the event of a PPAN failure. Failover keeps access to the Cisco web console open and enables certain aspects of {partner-product-short-name} to continue running. The failover state machine performs the following functions:

. Detect PPAN failures.
. Verify accessibility of the API gateway on SPAN.
. In the event of PPAN failure, promote SPAN to PPAN.
. Confirm that PAN failover has completed and is successful.

== AutoFailover

During deployment, if you set the Auto Failover (`AutoFailover`) parameter to `ENABLED`, the deployment schedules the failover state machine to run periodically as an https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-rules.html[Amazon EventBridge rule^]. The deployment sets `AutoFailover` to `DISABLED` by default in the templates, because there are only two {partner-product-short-name} nodes and auto failover can result in a 30-minute downtime while services are restarted.

== Parameter Store
This Partner Solution stores the following configurable parameters in https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html[AWS Systems Manager Parameter Store^].

[%autowidth]
|===
|Name |Description

|`ADMIN_PASSWORD` | {partner-product-short-name} administrator user password used by Lambda for Extensible RESTful Services (ERS)/OpenAPI requests.
|`ADMIN_USERNAME` |{partner-product-short-name} administrator user name used by Lambda for ERS/OpenAPI requests.
|`Maintenance` |Allowed values are `DISABLED` (default) and `ENABLED`. When `ENABLED`, Lambda skips health checks and PAN failover.
|`Primary_FQDN` |Fully qualified domain name (FQDN) of PPAN.
|`Primary_IP` |IPv4 address of PPAN.
|`Secondary_FQDN` |FQDN of SPAN.
|`Secondary_IP` |IPv4 address of SPAN.
|`SyncStatus` |Latest synchronization status of the {partner-product-short-name} deployment from the last health check.